{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Articles</title>
 <link rel="stylesheet" href="{% static 'articles.css' %}">

</head>
<body>

    <h2>All Articles</h2>
<div class="articles-container">
{% for article in articles %}
<div class="article-card" data-article-id="{{ article.id }}">
        <small>By {{ article.author }}</small>

        <h3>{{ article.title }}</h3>

        {% if article.image %}
            <img src="{{ article.image.url }}">
        {% endif %}
        <div class="reaction-row">
            <button type="button" class="like-btn"><span class="btn-icon">‚ù§Ô∏è</span> Like (<span class="like-count">0</span>)</button>
            <button type="button" class="dislike-btn"><span class="btn-icon">üëé</span> Dislike (<span class="dislike-count">0</span>)</button>
        </div>
               <p>{{ article.body }}</p>
               
        {% if user.is_authenticated %}
            {% if user.is_staff or user.username == article.author %}
            <a href="{% url 'edit_article' article.id %}">Edit</a>
            <form method="post" action="{% url 'delete_article' article.id %}" onsubmit="return confirm('Are you sure you want to delete this article?');">
                {% csrf_token %}
                <button type="submit">Delete</button>
            </form>
            {% endif %}
        {% endif %}
        
</div>
{% empty %}
    <p>No articles found.</p>
{% endfor %}

    </div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll(".article-card").forEach(function(card) {
            const articleId = card.dataset.articleId;
            const likeCount = card.querySelector(".like-count");
            const dislikeCount = card.querySelector(".dislike-count");
            const likeBtn = card.querySelector(".like-btn");
            const dislikeBtn = card.querySelector(".dislike-btn");

            const savedLikes = localStorage.getItem("article_" + articleId + "_likes");
            const savedDislikes = localStorage.getItem("article_" + articleId + "_dislikes");
            const likedOnce = localStorage.getItem("article_" + articleId + "_liked_once");
            const dislikedOnce = localStorage.getItem("article_" + articleId + "_disliked_once");
            let reaction = localStorage.getItem("article_" + articleId + "_reaction");
            likeCount.textContent = savedLikes ? savedLikes : 0;
            dislikeCount.textContent = savedDislikes ? savedDislikes : 0;

            if (!reaction) {
                if (likedOnce === "true") reaction = "like";
                if (dislikedOnce === "true") reaction = "dislike";
                if (reaction) {
                    localStorage.setItem("article_" + articleId + "_reaction", reaction);
                }
            }

            if (likedOnce === "true") {
                likeBtn.disabled = true;
            }
            if (dislikedOnce === "true") {
                dislikeBtn.disabled = true;
            }
            if (reaction === "like" || reaction === "dislike") {
                likeBtn.disabled = true;
                dislikeBtn.disabled = true;
            }
        });

        document.addEventListener("click", function(e) {
            const likeBtn = e.target.closest(".like-btn");
            const dislikeBtn = e.target.closest(".dislike-btn");
            if (!likeBtn && !dislikeBtn) return;

            const card = e.target.closest(".article-card");
            if (!card) return;

            const articleId = card.dataset.articleId;
            const likeCount = card.querySelector(".like-count");
            const dislikeCount = card.querySelector(".dislike-count");
            const reaction = localStorage.getItem("article_" + articleId + "_reaction");

            if (reaction === "like" || reaction === "dislike") return;

            if (likeBtn) {
                const likedOnce = localStorage.getItem("article_" + articleId + "_liked_once");
                if (likedOnce === "true") return;

                const nextLikes = Number(likeCount.textContent) + 1;
                likeCount.textContent = nextLikes;
                localStorage.setItem("article_" + articleId + "_likes", nextLikes);
                localStorage.setItem("article_" + articleId + "_liked_once", "true");
                localStorage.setItem("article_" + articleId + "_reaction", "like");
                likeBtn.disabled = true;
                dislikeBtn.disabled = true;
            }

            if (dislikeBtn) {
                const dislikedOnce = localStorage.getItem("article_" + articleId + "_disliked_once");
                if (dislikedOnce === "true") return;

                const nextDislikes = Number(dislikeCount.textContent) + 1;
                dislikeCount.textContent = nextDislikes;
                localStorage.setItem("article_" + articleId + "_dislikes", nextDislikes);
                localStorage.setItem("article_" + articleId + "_disliked_once", "true");
                localStorage.setItem("article_" + articleId + "_reaction", "dislike");
                dislikeBtn.disabled = true;
                likeBtn.disabled = true;
            }
        }, false);
    });
</script>
</body>
</html>
